import conv2dtfWGSL from './shaders/conv2dtf.wgsl';
import conv2dtf1WGSL from './shaders/conv2dtf1.wgsl';
import conv2dtf2WGSL from './shaders/conv2dtf2.wgsl';
import conv2dtf3WGSL from './shaders/conv2dtf3.wgsl';
import conv2dtf4WGSL from './shaders/conv2dtf4.wgsl';
import conv2dtf5WGSL from './shaders/conv2dtf5.wgsl';
import conv2d1tfWGSL from './shaders/conv2d1tf.wgsl';
import conv2d2tfWGSL from './shaders/conv2d2tf.wgsl';
import conv2d3tfWGSL from './shaders/conv2d3tf.wgsl';
import conv2d3tf1WGSL from './shaders/conv2d3tf1.wgsl';
import conv2d3tf2WGSL from './shaders/conv2d3tf2.wgsl';
import conv2d3tf3WGSL from './shaders/conv2d3tf3.wgsl';
import conv2d3tf4WGSL from './shaders/conv2d3tf4.wgsl';
import conv2d3tf5WGSL from './shaders/conv2d3tf5.wgsl';
import conv2d4tfWGSL from './shaders/conv2d4tf.wgsl';
import conv2d5tfWGSL from './shaders/conv2d5tf.wgsl';
import conv2d6tfWGSL from './shaders/conv2d6tf.wgsl';
import conv2d6tf1WGSL from './shaders/conv2d6tf1.wgsl';
import conv2d6tf2WGSL from './shaders/conv2d6tf2.wgsl';
import conv2d6tf3WGSL from './shaders/conv2d6tf3.wgsl';
import conv2d6tf4WGSL from './shaders/conv2d6tf4.wgsl';
import conv2d6tf5WGSL from './shaders/conv2d6tf5.wgsl';
import conv2d7tfWGSL from './shaders/conv2d7tf.wgsl';
import conv2d8tfWGSL from './shaders/conv2d8tf.wgsl';
import conv2d9tfWGSL from './shaders/conv2d9tf.wgsl';
import conv2d9tf1WGSL from './shaders/conv2d9tf1.wgsl';
import conv2d9tf2WGSL from './shaders/conv2d9tf2.wgsl';
import conv2d9tf3WGSL from './shaders/conv2d9tf3.wgsl';
import conv2d9tf4WGSL from './shaders/conv2d9tf4.wgsl';
import conv2d9tf5WGSL from './shaders/conv2d9tf5.wgsl';
import conv2d10tfWGSL from './shaders/conv2d10tf.wgsl';
import conv2d11tfWGSL from './shaders/conv2d11tf.wgsl';
import conv2d12tfWGSL from './shaders/conv2d12tf.wgsl';
import conv2d12tf1WGSL from './shaders/conv2d12tf1.wgsl';
import conv2d12tf2WGSL from './shaders/conv2d12tf2.wgsl';
import conv2d12tf3WGSL from './shaders/conv2d12tf3.wgsl';
import conv2d12tf4WGSL from './shaders/conv2d12tf4.wgsl';
import conv2d12tf5WGSL from './shaders/conv2d12tf5.wgsl';
import conv2d13tfWGSL from './shaders/conv2d13tf.wgsl';
import conv2d14tfWGSL from './shaders/conv2d14tf.wgsl';
import conv2d15tfWGSL from './shaders/conv2d15tf.wgsl';
import conv2d15tf1WGSL from './shaders/conv2d15tf1.wgsl';
import conv2d15tf2WGSL from './shaders/conv2d15tf2.wgsl';
import conv2d15tf3WGSL from './shaders/conv2d15tf3.wgsl';
import conv2d15tf4WGSL from './shaders/conv2d15tf4.wgsl';
import conv2d15tf5WGSL from './shaders/conv2d15tf5.wgsl';
import conv2d16tfWGSL from './shaders/conv2d16tf.wgsl';
import conv2d17tfWGSL from './shaders/conv2d17tf.wgsl';
import conv2d18tfWGSL from './shaders/conv2d18tf.wgsl';
import conv2d18tf1WGSL from './shaders/conv2d18tf1.wgsl';
import conv2d18tf2WGSL from './shaders/conv2d18tf2.wgsl';
import conv2d18tf3WGSL from './shaders/conv2d18tf3.wgsl';
import conv2d18tf4WGSL from './shaders/conv2d18tf4.wgsl';
import conv2d18tf5WGSL from './shaders/conv2d18tf5.wgsl';
import conv2d19tfWGSL from './shaders/conv2d19tf.wgsl';
import conv2d20tfWGSL from './shaders/conv2d20tf.wgsl';
import conv2d21tfWGSL from './shaders/conv2d21tf.wgsl';
import conv2d21tf1WGSL from './shaders/conv2d21tf1.wgsl';
import conv2d21tf2WGSL from './shaders/conv2d21tf2.wgsl';
import conv2d21tf3WGSL from './shaders/conv2d21tf3.wgsl';
import conv2d21tf4WGSL from './shaders/conv2d21tf4.wgsl';
import conv2d21tf5WGSL from './shaders/conv2d21tf5.wgsl';
import conv2d22tfWGSL from './shaders/conv2d22tf.wgsl';
import conv2d23tfWGSL from './shaders/conv2d23tf.wgsl';
import conv2d24tfWGSL from './shaders/conv2d24tf.wgsl';
import conv2d24tf1WGSL from './shaders/conv2d24tf1.wgsl';
import conv2d24tf2WGSL from './shaders/conv2d24tf2.wgsl';
import conv2d24tf3WGSL from './shaders/conv2d24tf3.wgsl';
import conv2d24tf4WGSL from './shaders/conv2d24tf4.wgsl';
import conv2d24tf5WGSL from './shaders/conv2d24tf5.wgsl';
import conv2d25tfWGSL from './shaders/conv2d25tf.wgsl';
import conv0upsWGSL from './shaders/conv0ups.wgsl';
import conv0ups1WGSL from './shaders/conv0ups1.wgsl';
import conv0ups2WGSL from './shaders/conv0ups2.wgsl';
import conv0ups3WGSL from './shaders/conv0ups3.wgsl';
import conv0ups4WGSL from './shaders/conv0ups4.wgsl';
import conv0ups5WGSL from './shaders/conv0ups5.wgsl';
import overlayConv1upsWGSL from './shaders/overlayConv1ups.wgsl';
import overlayConv1ups1WGSL from './shaders/overlayConv1ups1.wgsl';
import overlayConv1ups2WGSL from './shaders/overlayConv1ups2.wgsl';
import overlayConv1ups3WGSL from './shaders/overlayConv1ups3.wgsl';
import overlayConv1ups4WGSL from './shaders/overlayConv1ups4.wgsl';
import overlayConv1ups5WGSL from './shaders/overlayConv1ups5.wgsl';
import output from './shaders/output.wgsl';

import { Anime4KPipeline, Anime4KPipelineDescriptor } from '../../interfaces';
import { Conv2d, Overlay } from '../../helpers';

export class GANx4UUL implements Anime4KPipeline {
  /**
   * [0-5] conv2d_tf - conv2d_tf5
   * [6-11] conv2d_3_tf - conv2d_3_tf5
   * [12-17] conv2d_6_tf - conv2d_6_tf5
   * [18-23] conv2d_9_tf - conv2d_9_tf5
   * [24-29] conv2d_12_tf - conv2d_12_tf5
   * [30-35] conv2d_15_tf - conv2d_15_tf5
   * [36-41] conv2d_18_tf - conv2d_18_tf5
   * [42-47] conv2d_21_tf - conv2d_21_tf5
   * [48-53] conv2d_24_tf - conv2d_24_tf5
   */
  pipelines6: Anime4KPipeline[] = [];

  /**
   * [0] conv2d_1_tf;
   * [1] conv2d_2_tf;
   * [2] conv2d_4_tf;
   * [3] conv2d_5_tf;
   * [4] conv2d_7_tf;
   * [5] conv2d_8_tf;
   * [6] conv2d_10_tf;
   * [7] conv2d_11_tf;
   * [8] conv2d_13_tf;
   * [9] conv2d_14_tf;
   * [10] conv2d_16_tf;
   * [11] conv2d_17_tf;
   * [12] conv2d_19_tf;
   * [13] conv2d_20_tf;
   * [14] conv2d_22_tf;
   * [15] conv2d_23_tf;
   * [16] conv2d_25_tf;
   */
  pipelines: Anime4KPipeline[] = [];

  /**
   * [0-5] conv0ups - conv0ups5
   * [6-11] overlayConv1ups - overlayConv1ups5
   */
  pipelinesUps: Anime4KPipeline[] = [];

  constructor({
    device,
    inputTexture,
  }: Anime4KPipelineDescriptor) {
    const shaders6: string[] = [
      conv2dtfWGSL, conv2dtf1WGSL, conv2dtf2WGSL,
      conv2dtf3WGSL, conv2dtf4WGSL, conv2dtf5WGSL,
      conv2d3tfWGSL, conv2d3tf1WGSL, conv2d3tf2WGSL,
      conv2d3tf3WGSL, conv2d3tf4WGSL, conv2d3tf5WGSL,
      conv2d6tfWGSL, conv2d6tf1WGSL, conv2d6tf2WGSL,
      conv2d6tf3WGSL, conv2d6tf4WGSL, conv2d6tf5WGSL,
      conv2d9tfWGSL, conv2d9tf1WGSL, conv2d9tf2WGSL,
      conv2d9tf3WGSL, conv2d9tf4WGSL, conv2d9tf5WGSL,
      conv2d12tfWGSL, conv2d12tf1WGSL, conv2d12tf2WGSL,
      conv2d12tf3WGSL, conv2d12tf4WGSL, conv2d12tf5WGSL,
      conv2d15tfWGSL, conv2d15tf1WGSL, conv2d15tf2WGSL,
      conv2d15tf3WGSL, conv2d15tf4WGSL, conv2d15tf5WGSL,
      conv2d18tfWGSL, conv2d18tf1WGSL, conv2d18tf2WGSL,
      conv2d18tf3WGSL, conv2d18tf4WGSL, conv2d18tf5WGSL,
      conv2d21tfWGSL, conv2d21tf1WGSL, conv2d21tf2WGSL,
      conv2d21tf3WGSL, conv2d21tf4WGSL, conv2d21tf5WGSL,
      conv2d24tfWGSL, conv2d24tf1WGSL, conv2d24tf2WGSL,
      conv2d24tf3WGSL, conv2d24tf4WGSL, conv2d24tf5WGSL,
    ];

    const shaders: string[] = [
      conv2d1tfWGSL, conv2d2tfWGSL,
      conv2d4tfWGSL, conv2d5tfWGSL,
      conv2d7tfWGSL, conv2d8tfWGSL,
      conv2d10tfWGSL, conv2d11tfWGSL,
      conv2d13tfWGSL, conv2d14tfWGSL,
      conv2d16tfWGSL, conv2d17tfWGSL,
      conv2d19tfWGSL, conv2d20tfWGSL,
      conv2d22tfWGSL, conv2d23tfWGSL,
      conv2d25tfWGSL,
    ];

    const shadersUps: string[] = [
      conv0upsWGSL, conv0ups1WGSL, conv0ups2WGSL,
      conv0ups3WGSL, conv0ups4WGSL, conv0ups5WGSL,
      overlayConv1upsWGSL, overlayConv1ups1WGSL, overlayConv1ups2WGSL,
      overlayConv1ups3WGSL, overlayConv1ups4WGSL, overlayConv1ups5WGSL,
    ];

    let len = this.pipelines6.length;
    for (let i = 0; i < 6; i += 1) {
      // device, [inputTexture], shaders6[i], `conv2d_tf${i}`
      this.pipelines6.push(new Conv2d({
        device,
        inputTextures: [inputTexture],
        shaderWGSL: shaders6[i],
        name: `conv2d_tf_${i}`,
      }));
    }

    const outputTextures: GPUTexture[] = [];
    for (let i = 0; i < 8; i += 1) {
      outputTextures.length = 0;
      this.fillOutputTexturesFromPipeline6(outputTextures, len, 6);
      for (let j = 0; j < 2; j += 1) {
        // device, outputTextures, shaders[j + 2 * i], `conv2d_${j + 3 * i + 1}_tf`
        this.pipelines.push(new Conv2d({
          device,
          inputTextures: outputTextures,
          shaderWGSL: shaders[j + 2 * i],
          name: `conv2d_${j + 3 * i + 1}_tf`,
        }));
      }

      this.addOutputTexturesFromPipeline(outputTextures);
      len = this.pipelines6.length;
      for (let j = 0; j < 6; j += 1) {
        // device, outputTextures, shaders6[len + j], `conv2d_${3 * (i + 1)}_tf${j}`
        this.pipelines6.push(new Conv2d({
          device,
          inputTextures: outputTextures,
          shaderWGSL: shaders6[len + j],
          name: `conv2d_${3 * (i + 1)}_tf${j}`,
        }));
      }
    }

    outputTextures.length = 0;
    this.fillOutputTexturesFromPipeline6(outputTextures, 48, 6);
    // device, outputTextures, shaders[shaders.length - 1], 'conv2d_25_tf'
    this.pipelines.push(new Conv2d({
      device,
      inputTextures: outputTextures,
      shaderWGSL: shaders[shaders.length - 1],
      name: 'conv2d_25_tf',
    }));

    outputTextures.push(this.pipelines[15].getOutputTexture());
    for (let i = 0; i < 15; i += 1) {
      if (i % 2 === 0) {
        outputTextures.push(this.pipelines[i].getOutputTexture());
      }
    }
    outputTextures.push(this.pipelines[this.pipelines.length - 1].getOutputTexture());

    for (let i = 0; i < 6; i += 1) {
      // device, outputTextures, shadersUps[i], `conv0ups${i}`
      this.pipelinesUps.push(new Conv2d({
        device,
        inputTextures: outputTextures,
        shaderWGSL: shadersUps[i],
        name: `conv0ups${i}`,
      }));
    }

    outputTextures.length = 0;
    for (let i = 0; i < this.pipelinesUps.length; i += 1) {
      outputTextures.push(this.pipelinesUps[i].getOutputTexture());
    }

    for (let i = 0; i < 6; i += 1) {
      // device, outputTextures, [4 * inputTexture.width, 4 * inputTexture.height],
      // shadersUps[i + 6], `overlay_conv1ups${i}`
      this.pipelinesUps.push(new Overlay({
        device,
        inputTextures: outputTextures,
        outputTextureSize: [4 * inputTexture.width, 4 * inputTexture.height],
        fragmentWGSL: shadersUps[i + 6],
        name: `overlay_conv1ups${i}`,
      }));
    }

    outputTextures.length = 0;
    for (let i = 6; i < this.pipelinesUps.length; i += 1) {
      outputTextures.push(this.pipelinesUps[i].getOutputTexture());
    }
    // device, outputTextures, output, 'output'
    this.pipelinesUps.push(new Conv2d({
      device,
      inputTextures: outputTextures,
      shaderWGSL: output,
      name: 'output',
    }));
    // device, [this.pipelinesUps[this.pipelinesUps.length - 1].getOutputTexture(), inputTexture],
    // [4 * inputTexture.width, 4 * inputTexture.height], overlay2WGSL, 'Overlay'
    this.pipelinesUps.push(new Overlay({
      device,
      inputTextures: [
        this.pipelinesUps[this.pipelinesUps.length - 1].getOutputTexture(),
        inputTexture,
      ],
      outputTextureSize: [4 * inputTexture.width, 4 * inputTexture.height],
    }));
  }

  private fillOutputTexturesFromPipeline6(
    outputTextures: GPUTexture[],
    from: number,
    count: number,
  ) {
    for (let i = from; i < from + count; i += 1) {
      outputTextures.push(this.pipelines6[i].getOutputTexture());
    }
  }

  private addOutputTexturesFromPipeline(outputTextures: GPUTexture[]) {
    const len = this.pipelines.length;
    outputTextures.push(this.pipelines[len - 1].getOutputTexture());
    for (let i = 0; i < len; i += 1) {
      if (i % 2 === 0) {
        outputTextures.push(this.pipelines[i].getOutputTexture());
      }
    }
  }

  updateParam(param: string, value: any): void {
    throw new Error('Method not implemented.');
  }

  pass(encoder: GPUCommandEncoder): void {
    for (let i = 0; i < 9; i += 1) {
      for (let j = 0; j < 6; j += 1) {
        this.pipelines6[6 * i + j].pass(encoder);
      }

      if (i !== 8) {
        this.pipelines[2 * i].pass(encoder);
        this.pipelines[2 * i + 1].pass(encoder);
      }
    }

    // conv2d_25_tf
    this.pipelines[16].pass(encoder);

    for (let i = 0; i < this.pipelinesUps.length; i += 1) {
      this.pipelinesUps[i].pass(encoder);
    }
  }

  getOutputTexture(): GPUTexture {
    return this.pipelinesUps[this.pipelinesUps.length - 1].getOutputTexture();
  }
}
